<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acme Dev Studio (Interactive)</title>
    
    <!-- Core Libraries -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Loader */
        #loader { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #0d1117; z-index: 50; }
        .spinner { width: 40px; height: 40px; border: 4px solid #30363d; border-top-color: #1f6feb; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- 1. HTML Loader -->
    <div id="loader">
        <div class="spinner"></div>
        <h2 style="margin-top: 20px; color: #c9d1d9;">Loading Interactive Studio...</h2>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component } = React;

        // --- 2. ERROR BOUNDARY ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    document.getElementById('loader').style.display = 'none';
                    return <div className="p-8 text-red-400"><h1>Crashed</h1><pre>{this.state.error.toString()}</pre></div>;
                }
                return this.props.children; 
            }
        }

        // --- 3. SAFE ICON SYSTEM ---
        const ICONS = {
            FileCode: ["M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z", "14 2 14 8 20 8"],
            Folder: ["M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"],
            Play: ["5 3 19 12 5 21 5 3"],
            Terminal: ["4 17 10 11 4 5", "12 19 20 19"],
            GitBranch: ["6 3 6 15", "18 6 3", "6 18 3", "M18 9a9 9 0 0 1-9 9"],
            Check: ["20 6 9 17 4 12"],
            Cpu: ["4 4 16 16 2 2", "9 1 9 4", "15 1 15 4", "9 20 9 23", "15 20 15 23", "20 9 23 9", "20 14 23 14", "1 9 4 9", "1 14 4 14"],
            Cloud: ["M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"],
            Activity: ["22 12 18 12 15 21 9 3 6 12 2 12"],
            Server: ["2 2 20 8 2 2", "2 14 20 8 2 2", "6 6 6.01 6", "6 18 6.01 18"],
            Send: ["22 2 15 22 11 13 2 9 22 2"],
            Loader: ["M12 2v4", "M12 18v4", "M4.93 4.93l2.83 2.83", "M16.24 16.24l2.83 2.83", "M2 12h4", "M18 12h4", "M4.93 19.07l2.83-2.83", "M16.24 7.76l2.83-2.83"]
        };

        const Icon = ({ name, size = 16, className = "" }) => {
            const data = ICONS[name] || [];
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {data.map((d, i) => {
                        if (d.includes('M') || d.includes('A')) return <path key={i} d={d} />;
                        if (d.split(' ').length > 4) return <polyline key={i} points={d} />;
                        if (d.split(' ').length === 4) { const [x1,y1,x2,y2] = d.split(' '); return <line key={i} x1={x1} y1={y1} x2={x2} y2={y2} />; }
                        if (d.split(' ').length === 6) { const [x,y,w,h,rx,ry] = d.split(' '); return <rect key={i} x={x} y={y} width={w} height={h} rx={rx} ry={ry} />; }
                        if (d.split(' ').length === 3) { const [cx,cy,r] = d.split(' '); return <circle key={i} cx={cx} cy={cy} r={r} />; }
                        return null;
                    })}
                </svg>
            );
        };

        // --- 4. APP DATA ---
        const FILES = {
            legacy: ['UserController.cs', 'Web.config', 'Global.asax'],
            modern: ['users.py', 'main.py', 'requirements.txt', 'Dockerfile']
        };

        const MCP_TOOLS = [
            { name: "fs-reader", status: "Active", desc: "Analyzing file structure" },
            { name: "dotnet-analyzer", status: "Idle", desc: "Parsing C# AST" },
            { name: "python-transpiler", status: "Idle", desc: "Generating FastAPI code" },
            { name: "terraform-cloud", status: "Idle", desc: "Provisioning AWS resources" },
            { name: "bitbucket-connector", status: "Disabled", desc: "Waiting for PR" }
        ];

        // --- 4.5 NEW COMPONENT: ARCHITECTURE DIAGRAM (Mermaid Style) ---
        const ArchitectureDiagram = () => (
            <div className="flex flex-col items-center justify-center h-full w-full p-8 animate-in">
                <h3 className="text-[#c9d1d9] font-bold mb-6 flex items-center gap-2"><Icon name="Activity" className="text-green-400"/> System Architecture (Target State)</h3>
                
                <svg width="600" height="200" viewBox="0 0 600 200" className="border border-[#30363d] bg-[#010409] rounded-lg shadow-lg">
                    <defs>
                        <marker id="arrow" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto" markerUnits="strokeWidth">
                            <path d="M0,0 L0,6 L9,3 z" fill="#8b949e" />
                        </marker>
                    </defs>

                    {/* Nodes */}
                    <g transform="translate(50, 75)">
                        <rect width="100" height="50" rx="4" fill="#161b22" stroke="#58a6ff" strokeWidth="2"/>
                        <text x="50" y="30" textAnchor="middle" fill="#c9d1d9" fontSize="12" fontFamily="monospace">Client</text>
                    </g>

                    <g transform="translate(200, 75)">
                        <rect width="100" height="50" rx="4" fill="#161b22" stroke="#a371f7" strokeWidth="2"/>
                        <text x="50" y="30" textAnchor="middle" fill="#c9d1d9" fontSize="12" fontFamily="monospace">ALB</text>
                    </g>

                    <g transform="translate(350, 60)">
                        <rect width="100" height="80" rx="4" fill="#161b22" stroke="#3fb950" strokeWidth="2"/>
                        <text x="50" y="25" textAnchor="middle" fill="#3fb950" fontSize="10" fontWeight="bold">ECS Cluster</text>
                        <rect x="10" y="35" width="80" height="35" rx="2" fill="#0d1117" stroke="#3fb950" strokeDasharray="2 2"/>
                        <text x="50" y="57" textAnchor="middle" fill="#c9d1d9" fontSize="10">Python API</text>
                    </g>

                    <g transform="translate(500, 75)">
                         {/* Database Cylinder look */}
                         <path d="M10,0 a40,10 0 1,1 80,0 a40,10 0 1,1 -80,0" fill="#161b22" stroke="#f0883e" strokeWidth="2" transform="translate(0, -5)"/>
                         <path d="M10,0 v50 a40,10 0 1,0 80,0 v-50" fill="#161b22" stroke="#f0883e" strokeWidth="2"/>
                        <text x="50" y="30" textAnchor="middle" fill="#c9d1d9" fontSize="12" fontFamily="monospace">RDS (PG)</text>
                    </g>

                    {/* Links */}
                    <line x1="150" y1="100" x2="200" y2="100" stroke="#8b949e" strokeWidth="2" markerEnd="url(#arrow)"/>
                    <line x1="300" y1="100" x2="350" y2="100" stroke="#8b949e" strokeWidth="2" markerEnd="url(#arrow)"/>
                    <line x1="450" y1="100" x2="500" y2="100" stroke="#8b949e" strokeWidth="2" markerEnd="url(#arrow)"/>
                </svg>

                <div className="mt-6 w-full max-w-2xl bg-[#161b22] border border-[#30363d] rounded-lg p-4">
                     <h4 className="text-[#8b949e] text-xs uppercase font-bold mb-3">Deployment Specifications</h4>
                     <div className="grid grid-cols-2 gap-4 text-xs">
                        <div className="flex justify-between border-b border-[#30363d] pb-1">
                            <span className="text-[#8b949e]">Orchestration</span>
                            <span className="text-[#c9d1d9] font-mono">Terraform (AWS)</span>
                        </div>
                        <div className="flex justify-between border-b border-[#30363d] pb-1">
                            <span className="text-[#8b949e]">Runtime</span>
                            <span className="text-[#c9d1d9] font-mono">Python 3.11 / FastAPI</span>
                        </div>
                        <div className="flex justify-between border-b border-[#30363d] pb-1">
                            <span className="text-[#8b949e]">Database</span>
                            <span className="text-[#c9d1d9] font-mono">PostgreSQL 15</span>
                        </div>
                        <div className="flex justify-between border-b border-[#30363d] pb-1">
                            <span className="text-[#8b949e]">CI/CD</span>
                            <span className="text-[#c9d1d9] font-mono">Bitbucket Pipelines</span>
                        </div>
                     </div>
                </div>
            </div>
        );

        // --- 5. MAIN COMPONENT ---
        const App = () => {
            const [status, setStatus] = useState('idle');
            const [activeFile, setActiveFile] = useState('welcome');
            const [terminalLogs, setTerminalLogs] = useState(["> Agent initialized. Standing by."]);
            const [agentChat, setAgentChat] = useState([{role: 'agent', text: "Ready. Click 'Start Analysis' to begin."}]);
            const [activeTab, setActiveTab] = useState('terminal');
            const [showModernFiles, setShowModernFiles] = useState(false);
            const [userInput, setUserInput] = useState("");
            const [waitingForInput, setWaitingForInput] = useState(false);
            
            // Workflow Steps: pending, active, done
            const [steps, setSteps] = useState([
                { id: 'scan', label: 'Scan & Analysis', status: 'pending' },
                { id: 'plan', label: 'Architecture Plan', status: 'pending' },
                { id: 'code', label: 'Refactoring', status: 'pending' },
                { id: 'verify', label: 'Verification', status: 'pending' },
                { id: 'deploy', label: 'Git Push', status: 'pending' }
            ]);

            const terminalEndRef = useRef(null);
            const chatEndRef = useRef(null);

            useEffect(() => { document.getElementById('loader').style.display = 'none'; }, []);
            useEffect(() => { terminalEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [terminalLogs]);
            useEffect(() => { chatEndRef.current?.scrollIntoView({ behavior: "smooth" }); }, [agentChat]);

            const addLog = (msg) => setTerminalLogs(prev => [...prev, `> ${msg}`]);
            const addChat = (text, role='agent') => setAgentChat(prev => [...prev, {role, text}]);
            const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            const updateStep = (id, status) => {
                setSteps(prev => prev.map(s => s.id === id ? { ...s, status } : s));
            };

            // --- MIGRATION LOGIC ---
            
            // Step 1: Scan & Plan
            const startMigration = async () => {
                setStatus('running');
                updateStep('scan', 'active');
                addChat("Starting analysis...", 'agent');
                
                await wait(1000);
                addLog("mcp: fs-reader reading ./src/legacy...");
                addLog("Identified ASP.NET MVC architecture.");
                updateStep('scan', 'done');
                
                updateStep('plan', 'active');
                await wait(1000);
                setActiveFile('report');
                addChat("I have generated an architecture plan (see 'Architecture' tab). We will move to AWS ECS with Python FastAPI.", 'agent');
                addChat("Do you approve this plan? (Type 'yes' to proceed)", 'agent');
                
                setWaitingForInput('approve_plan'); // PAUSE FOR INPUT
            };

            // Step 2: Code & Verify
            const runCodingPhase = async () => {
                updateStep('plan', 'done');
                updateStep('code', 'active');
                addLog("Starting refactoring phase...");
                
                await wait(1500);
                addLog("mcp: python-transpiler converting C# -> Python...");
                setShowModernFiles(true);
                setActiveFile('diff');
                
                await wait(1500);
                updateStep('code', 'done');
                updateStep('verify', 'active');
                
                addLog("Running verification suite...");
                addLog("pytest tests/ ... PASS");
                addLog("terraform plan ... PASS");
                
                await wait(1000);
                updateStep('verify', 'done');
                addChat("Refactoring complete and tests passed. Ready to deploy?", 'agent');
                setWaitingForInput('approve_deploy'); // PAUSE FOR INPUT
            };

            // Step 3: Deploy
            const runDeployPhase = async () => {
                updateStep('deploy', 'active');
                addLog("git remote add origin bitbucket.org/acme/service.git");
                addLog("git push origin main");
                
                await wait(2000);
                updateStep('deploy', 'done');
                setStatus('complete');
                addChat("Deployment complete. PR #1042 created.", 'agent');
                setWaitingForInput(false);
            };

            const handleUserSubmit = (e) => {
                e.preventDefault();
                if (!userInput.trim()) return;
                
                addChat(userInput, 'user');
                const input = userInput.toLowerCase();
                setUserInput("");

                if (waitingForInput === 'approve_plan') {
                    if (input.includes('yes') || input.includes('ok')) {
                        addChat("Plan approved. Starting coding phase...", 'agent');
                        setWaitingForInput(false);
                        runCodingPhase();
                    } else {
                        addChat("I can only proceed with approval. Please type 'yes' to continue, or restart.", 'agent');
                    }
                } else if (waitingForInput === 'approve_deploy') {
                     if (input.includes('yes') || input.includes('ok') || input.includes('push')) {
                        addChat("Initiating deployment...", 'agent');
                        setWaitingForInput(false);
                        runDeployPhase();
                    }
                } else {
                    // General chat fallback
                    setTimeout(() => addChat("I am focusing on the migration task. Please follow the approval flow.", 'agent'), 500);
                }
            };

            return (
                <div className="flex flex-col h-screen w-full overflow-hidden text-sm">
                    {/* Header */}
                    <header className="h-12 bg-[#161b22] border-b border-[#30363d] flex items-center justify-between px-4 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-1 rounded text-white"><Icon name="Cpu" size={16}/></div>
                            <span className="font-semibold text-white">Acme Dev Studio</span>
                            <span className={`px-2 py-0.5 rounded-full border border-[#30363d] text-xs ${status === 'running' ? 'text-green-400 animate-pulse' : 'text-[#8b949e]'}`}>
                                {status.toUpperCase()}
                            </span>
                        </div>
                        {status === 'idle' && (
                            <button onClick={startMigration} className="bg-[#238636] text-white px-3 py-1 rounded hover:bg-[#2ea043] flex items-center gap-2 border border-white/10">
                                <Icon name="Play" size={12}/> Start Analysis
                            </button>
                        )}
                    </header>

                    <div className="flex-1 flex min-h-0">
                        {/* LEFT SIDEBAR: FLOW & FILES */}
                        <div className="w-64 bg-[#0d1117] border-r border-[#30363d] flex flex-col shrink-0">
                            {/* Workflow Tracker */}
                            <div className="p-3 border-b border-[#30363d]">
                                <div className="text-xs font-bold text-[#8b949e] uppercase tracking-wider mb-2">Migration Flow</div>
                                <div className="space-y-2">
                                    {steps.map(s => (
                                        <div key={s.id} className="flex items-center gap-2 text-xs">
                                            <div className={`w-2 h-2 rounded-full ${s.status === 'done' ? 'bg-green-500' : s.status === 'active' ? 'bg-blue-500 animate-pulse' : 'bg-[#30363d]'}`}></div>
                                            <span className={s.status === 'active' ? 'text-white font-medium' : s.status === 'done' ? 'text-[#c9d1d9]' : 'text-[#8b949e]'}>{s.label}</span>
                                        </div>
                                    ))}
                                </div>
                            </div>

                            {/* Explorer */}
                            <div className="flex-1 overflow-y-auto p-2">
                                <div className="text-xs font-bold text-[#8b949e] uppercase tracking-wider mb-2 px-2">Files</div>
                                <div className="px-2 py-1 text-[#8b949e] flex items-center gap-2"><Icon name="Folder" size={14} className="text-yellow-600"/> src/legacy</div>
                                {FILES.legacy.map(f => <div key={f} className="px-2 py-1 pl-7 text-[#c9d1d9] flex items-center gap-2 text-xs"><Icon name="FileCode" size={12} className="text-blue-400"/> {f}</div>)}
                                {showModernFiles && (
                                    <div className="animate-in mt-2">
                                        <div className="px-2 py-1 text-[#8b949e] flex items-center gap-2"><Icon name="Folder" size={14} className="text-green-600"/> src/modern</div>
                                        {FILES.modern.map(f => <div key={f} className="px-2 py-1 pl-7 text-[#c9d1d9] flex items-center gap-2 text-xs"><Icon name="FileCode" size={12} className="text-green-400"/> {f}</div>)}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* CENTER: EDITOR */}
                        <div className="flex-1 flex flex-col bg-[#0d1117] min-w-0 border-r border-[#30363d]">
                            <div className="h-9 bg-[#010409] flex items-center border-b border-[#30363d]">
                                <button onClick={()=>setActiveFile('diff')} className={`px-4 h-full border-r border-[#30363d] text-xs flex items-center ${activeFile==='diff' ? 'bg-[#0d1117] border-t-2 border-t-[#f78166] text-[#c9d1d9]' : 'text-[#8b949e]'}`}>Code Diff</button>
                                <button onClick={()=>setActiveFile('report')} className={`px-4 h-full border-r border-[#30363d] text-xs flex items-center ${activeFile==='report' ? 'bg-[#0d1117] border-t-2 border-t-[#238636] text-[#c9d1d9]' : 'text-[#8b949e]'}`}>Architecture</button>
                            </div>

                            <div className="flex-1 overflow-auto relative p-4">
                                {activeFile === 'welcome' && (
                                    <div className="flex flex-col items-center justify-center h-full text-[#8b949e] gap-4">
                                        <Icon name="Cpu" size={64} className="opacity-20"/>
                                        <p>Ready to analyze.</p>
                                    </div>
                                )}
                                {activeFile === 'diff' && (
                                    <div className="flex h-full font-mono text-xs gap-4">
                                        <div className="w-1/2 border border-[#30363d] rounded bg-[#0d1117] p-2 overflow-auto">
                                            <div className="text-[#8b949e] mb-2 uppercase text-[10px]">C# Source</div>
                                            <div className="text-red-300">public class UserController : Controller {'{'}</div>
                                            <div className="text-[#c9d1d9] pl-4">private UserContext db = new UserContext();</div>
                                            <div className="text-[#8b949e] pl-4 italic">// ISSUE: Direct DB Access</div>
                                            <div className="text-[#c9d1d9] pl-4">return View(db.Users.ToList());</div>
                                            <div className="text-red-300">{'}'}</div>
                                        </div>
                                        <div className="w-1/2 border border-[#30363d] rounded bg-[#0d1117] p-2 overflow-auto">
                                            <div className="text-[#238636] mb-2 uppercase text-[10px]">Python Target</div>
                                            <div className="text-green-300">@router.get("/users")</div>
                                            <div className="text-[#c9d1d9]">async def read_users(db: Session = Depends(get_db)):</div>
                                            <div className="text-[#8b949e] pl-4 italic"># FIXED: Async & DI</div>
                                            <div className="text-[#c9d1d9] pl-4">return service.get_all_users(db)</div>
                                        </div>
                                    </div>
                                )}
                                {activeFile === 'report' && (
                                    <ArchitectureDiagram />
                                )}
                            </div>

                            {/* Terminal */}
                            <div className="h-40 border-t border-[#30363d] bg-[#010409] flex flex-col">
                                <div className="flex border-b border-[#30363d]">
                                    <button onClick={() => setActiveTab('terminal')} className={`px-4 py-1 text-xs ${activeTab === 'terminal' ? 'text-white border-b border-[#f78166]' : 'text-[#8b949e]'}`}>Terminal</button>
                                    <button onClick={() => setActiveTab('mcp')} className={`px-4 py-1 text-xs ${activeTab === 'mcp' ? 'text-white border-b border-[#f78166]' : 'text-[#8b949e]'}`}>MCP Tools</button>
                                </div>
                                <div className="flex-1 overflow-auto p-2 font-mono text-xs">
                                    {activeTab === 'terminal' && <div>{terminalLogs.map((l, i) => <div key={i} className="text-[#8b949e]">{l}</div>)}<div ref={terminalEndRef}/></div>}
                                    {activeTab === 'mcp' && (
                                        <div className="grid grid-cols-2 gap-2">
                                            {MCP_TOOLS.map(t => <div key={t.name} className="p-2 border border-[#30363d] rounded bg-[#0d1117] text-[#c9d1d9] flex justify-between"><span>{t.name}</span><span className="text-[#8b949e]">{t.status}</span></div>)}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* RIGHT SIDEBAR: CHAT */}
                        <div className="w-80 bg-[#0d1117] flex flex-col border-l border-[#30363d] shrink-0">
                            <div className="p-2 text-xs font-bold text-[#8b949e] uppercase tracking-wider border-b border-[#30363d]">Agent Chat</div>
                            <div className="flex-1 overflow-y-auto p-3 space-y-3">
                                {agentChat.map((c, i) => (
                                    <div key={i} className={`flex ${c.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[90%] p-2 rounded text-xs border ${c.role === 'user' ? 'bg-[#1f6feb]/20 border-[#1f6feb]/50 text-white' : 'bg-[#161b22] border-[#30363d] text-[#c9d1d9]'}`}>
                                            <div className="font-bold opacity-50 mb-0.5 uppercase text-[8px]">{c.role}</div>
                                            {c.text}
                                        </div>
                                    </div>
                                ))}
                                <div ref={chatEndRef}/>
                            </div>
                            
                            {/* Input Area */}
                            <div className="p-3 border-t border-[#30363d] bg-[#161b22]">
                                <form onSubmit={handleUserSubmit} className="flex gap-2">
                                    <input 
                                        type="text" 
                                        value={userInput}
                                        onChange={(e) => setUserInput(e.target.value)}
                                        placeholder={waitingForInput ? "Type 'yes' to proceed..." : "Agent running..."}
                                        disabled={!waitingForInput}
                                        className="flex-1 bg-[#0d1117] border border-[#30363d] rounded px-2 py-1 text-xs text-white focus:border-[#1f6feb] outline-none disabled:opacity-50"
                                    />
                                    <button type="submit" disabled={!waitingForInput} className="bg-[#238636] text-white p-1 rounded hover:bg-[#2ea043] disabled:opacity-50 disabled:cursor-not-allowed">
                                        <Icon name="Send" size={14} />
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<ErrorBoundary><App /></ErrorBoundary>);
    </script>
</body>
</html>


