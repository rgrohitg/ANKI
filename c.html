<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Acme Dev Studio (Safe Mode)</title>
    
    <!-- Core Libraries -->
    <script crossorigin src="https://unpkg.com/react@18.2.0/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18.2.0/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Font -->
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #c9d1d9; }
        .font-mono { font-family: 'JetBrains Mono', monospace; }
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0d1117; }
        ::-webkit-scrollbar-thumb { background: #30363d; border-radius: 4px; }
        .animate-in { animation: fadeIn 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Syntax Colors */
        .k { color: #ff7b72; } /* Keyword */
        .s { color: #a5d6ff; } /* String */
        .f { color: #d2a8ff; } /* Function */
        .c { color: #8b949e; font-style: italic; } /* Comment */
        .t { color: #79c0ff; } /* Type */

        /* Loader */
        #loader { position: fixed; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; background: #0d1117; z-index: 50; }
        .spinner { width: 40px; height: 40px; border: 4px solid #30363d; border-top-color: #1f6feb; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }
    </style>
</head>
<body>
    <!-- 1. HTML Loader (Visible until React mounts) -->
    <div id="loader">
        <div class="spinner"></div>
        <h2 style="margin-top: 20px; color: #c9d1d9;">Loading Dev Studio...</h2>
    </div>

    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, Component } = React;

        // --- 2. ERROR BOUNDARY (Catches Crashes) ---
        class ErrorBoundary extends Component {
            constructor(props) { super(props); this.state = { hasError: false, error: null }; }
            static getDerivedStateFromError(error) { return { hasError: true, error }; }
            render() {
                if (this.state.hasError) {
                    document.getElementById('loader').style.display = 'none';
                    return (
                        <div className="p-8 text-red-400 bg-[#0d1117] h-screen flex flex-col items-center justify-center">
                            <h1 className="text-xl font-bold mb-4">Studio Crashed</h1>
                            <pre className="bg-black p-4 rounded border border-red-900 text-xs overflow-auto max-w-2xl">{this.state.error.toString()}</pre>
                            <button onClick={() => window.location.reload()} className="mt-4 px-4 py-2 bg-red-800 text-white rounded">Reload</button>
                        </div>
                    );
                }
                return this.props.children; 
            }
        }

        // --- 3. SAFE ICON SYSTEM (Data Only) ---
        const ICONS = {
            FileCode: ["M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z", "14 2 14 8 20 8"],
            Folder: ["M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"],
            Play: ["5 3 19 12 5 21 5 3"], // Polygon points
            Terminal: ["4 17 10 11 4 5", "12 19 20 19"], // Polyline points, Line coords
            GitBranch: ["6 3 6 15", "18 6 3", "6 18 3", "M18 9a9 9 0 0 1-9 9"],
            Check: ["20 6 9 17 4 12"],
            Cpu: ["4 4 16 16 2 2", "9 1 9 4", "15 1 15 4", "9 20 9 23", "15 20 15 23", "20 9 23 9", "20 14 23 14", "1 9 4 9", "1 14 4 14"],
            Cloud: ["M18 10h-1.26A8 8 0 1 0 9 20h9a5 5 0 0 0 0-10z"],
            Activity: ["22 12 18 12 15 21 9 3 6 12 2 12"],
            Server: ["2 2 20 8 2 2", "2 14 20 8 2 2", "6 6 6.01 6", "6 18 6.01 18"],
            Search: ["11 11 8", "21 21 16.65 16.65"] // Circle cx cy r, Line x1 y1 x2 y2
        };

        const Icon = ({ name, size = 16, className = "" }) => {
            const data = ICONS[name] || [];
            // Simple heuristics to decide SVG element type based on data string format
            return (
                <svg width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>
                    {data.map((d, i) => {
                        if (d.includes('M') || d.includes('A')) return <path key={i} d={d} />;
                        if (d.split(' ').length > 4 && !d.includes('M')) return <polyline key={i} points={d} />;
                        if (d.split(' ').length === 4) { const [x1,y1,x2,y2] = d.split(' '); return <line key={i} x1={x1} y1={y1} x2={x2} y2={y2} />; }
                        if (d.split(' ').length === 6) { const [x,y,w,h,rx,ry] = d.split(' '); return <rect key={i} x={x} y={y} width={w} height={h} rx={rx} ry={ry} />; }
                        if (d.split(' ').length === 3) { const [cx,cy,r] = d.split(' '); return <circle key={i} cx={cx} cy={cy} r={r} />; }
                        return null;
                    })}
                </svg>
            );
        };

        // --- 4. APP DATA ---
        const FILES = {
            legacy: ['UserController.cs', 'Web.config', 'Global.asax'],
            modern: ['users.py', 'main.py', 'requirements.txt', 'Dockerfile']
        };

        const MCP_TOOLS = [
            { name: "fs-reader", status: "Active", desc: "Analyzing file structure" },
            { name: "dotnet-analyzer", status: "Idle", desc: "Parsing C# AST" },
            { name: "python-transpiler", status: "Idle", desc: "Generating FastAPI code" },
            { name: "terraform-cloud", status: "Idle", desc: "Provisioning AWS resources" },
            { name: "bitbucket-connector", status: "Disabled", desc: "Waiting for PR" }
        ];

        // --- 5. MAIN COMPONENT ---
        const App = () => {
            const [status, setStatus] = useState('init');
            const [activeFile, setActiveFile] = useState('welcome');
            const [terminalLogs, setTerminalLogs] = useState(["> Migration Agent Initialized..."]);
            const [agentChat, setAgentChat] = useState([{role: 'agent', text: "Ready to migrate. Click 'Start Migration' to begin."}]);
            const [activeTab, setActiveTab] = useState('terminal');
            const [showModernFiles, setShowModernFiles] = useState(false);
            const terminalEndRef = useRef(null);

            useEffect(() => {
                // Remove loader when React mounts
                const loader = document.getElementById('loader');
                if(loader) loader.style.display = 'none';
            }, []);

            useEffect(() => {
                terminalEndRef.current?.scrollIntoView({ behavior: "smooth" });
            }, [terminalLogs]);

            const addLog = (msg) => setTerminalLogs(prev => [...prev, `> ${msg}`]);
            const addChat = (text, role='agent') => setAgentChat(prev => [...prev, {role, text}]);
            const wait = (ms) => new Promise(resolve => setTimeout(resolve, ms));

            const runMigration = async () => {
                setStatus('scanning');
                addChat("Starting analysis. Scanning source code...", 'agent');
                
                await wait(800);
                addLog("mcp: fs-reader reading ./src/legacy...");
                addLog("Found 12 .cs files, 1 .config");
                
                await wait(1200);
                addChat("I've identified an ASP.NET MVC application. Refactoring to Python FastAPI.", 'agent');
                
                await wait(1500);
                setStatus('coding');
                setActiveFile('diff');
                addLog("mcp: python-transpiler converting UserController.cs -> users.py...");
                setShowModernFiles(true);
                
                await wait(2000);
                addChat("Code conversion complete. Running verification tests.", 'agent');
                
                setStatus('verifying');
                setActiveTab('terminal');
                addLog("Running: pytest tests/");
                addLog("test_users.py ... PASS");
                addLog("Running: terraform plan");
                addLog("Plan: 4 to add, 0 to change, 0 to destroy.");
                
                await wait(2000);
                setStatus('pr_ready');
                addChat("Verification successful. Ready to push to Bitbucket?", 'agent');
            };

            const pushToGit = async () => {
                setStatus('pushing');
                addChat("Yes, please push to Bitbucket.", 'user');
                await wait(1000);
                addLog("git remote add origin git@bitbucket.org:acme/new-service.git");
                addLog("git push -u origin feature/migration-v1");
                
                await wait(1500);
                setStatus('complete');
                setActiveFile('report');
                addChat("Code pushed. Pull Request created: PR-1042. View report.", 'agent');
            };

            return (
                <div className="flex flex-col h-screen w-full overflow-hidden text-sm">
                    {/* Header */}
                    <header className="h-12 bg-[#161b22] border-b border-[#30363d] flex items-center justify-between px-4 shrink-0">
                        <div className="flex items-center gap-3">
                            <div className="bg-blue-600 p-1 rounded text-white"><Icon name="Cpu" size={16}/></div>
                            <span className="font-semibold text-white">Acme Dev Studio</span>
                            <span className="px-2 py-0.5 rounded-full border border-[#30363d] text-xs text-[#8b949e]">
                                {status === 'init' ? 'Idle' : status.toUpperCase()}
                            </span>
                        </div>
                        <div className="flex gap-2">
                            {status === 'init' && (
                                <button onClick={runMigration} className="bg-[#238636] text-white px-3 py-1 rounded hover:bg-[#2ea043] flex items-center gap-2 border border-white/10">
                                    <Icon name="Play" size={12}/> Start Migration
                                </button>
                            )}
                            {status === 'pr_ready' && (
                                <button onClick={pushToGit} className="bg-[#1f6feb] text-white px-3 py-1 rounded hover:bg-[#388bfd] flex items-center gap-2 animate-pulse">
                                    <Icon name="GitBranch" size={12}/> Push to Bitbucket
                                </button>
                            )}
                        </div>
                    </header>

                    {/* Main Area */}
                    <div className="flex-1 flex min-h-0">
                        {/* Sidebar */}
                        <div className="w-64 bg-[#0d1117] border-r border-[#30363d] flex flex-col shrink-0">
                            <div className="p-2 text-xs font-bold text-[#8b949e] uppercase tracking-wider">Explorer</div>
                            <div className="flex-1 overflow-y-auto">
                                <div className="mb-4">
                                    <div className="px-3 py-1 text-[#8b949e] flex items-center gap-2"><Icon name="Folder" size={14} className="text-yellow-600"/> src/legacy</div>
                                    {FILES.legacy.map(f => <div key={f} className="px-3 py-1 pl-8 text-[#c9d1d9] flex items-center gap-2 hover:bg-[#161b22] cursor-pointer"><Icon name="FileCode" size={12} className="text-blue-400"/> {f}</div>)}
                                </div>
                                {showModernFiles && (
                                    <div className="animate-in">
                                        <div className="px-3 py-1 text-[#8b949e] flex items-center gap-2"><Icon name="Folder" size={14} className="text-green-600"/> src/modern</div>
                                        {FILES.modern.map(f => <div key={f} className="px-3 py-1 pl-8 text-[#c9d1d9] flex items-center gap-2 hover:bg-[#161b22] cursor-pointer"><Icon name="FileCode" size={12} className="text-green-400"/> {f}</div>)}
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Editor Area */}
                        <div className="flex-1 flex flex-col bg-[#0d1117] min-w-0 border-r border-[#30363d]">
                            {/* Tabs */}
                            <div className="h-9 bg-[#010409] flex items-center border-b border-[#30363d]">
                                <button onClick={()=>setActiveFile('diff')} className={`px-4 h-full border-r border-[#30363d] text-xs flex items-center ${activeFile==='diff' ? 'bg-[#0d1117] border-t-2 border-t-[#f78166] text-[#c9d1d9]' : 'text-[#8b949e]'}`}>Code Diff</button>
                                <button onClick={()=>setActiveFile('report')} className={`px-4 h-full border-r border-[#30363d] text-xs flex items-center ${activeFile==='report' ? 'bg-[#0d1117] border-t-2 border-t-[#238636] text-[#c9d1d9]' : 'text-[#8b949e]'}`}>Architecture</button>
                            </div>

                            {/* Canvas */}
                            <div className="flex-1 overflow-auto relative p-4">
                                {activeFile === 'welcome' && (
                                    <div className="flex flex-col items-center justify-center h-full text-[#8b949e] gap-4">
                                        <Icon name="Cpu" size={64} className="opacity-20"/>
                                        <p>Ready to analyze.</p>
                                    </div>
                                )}
                                
                                {activeFile === 'diff' && (
                                    <div className="flex h-full font-mono text-xs gap-4">
                                        <div className="w-1/2 border border-[#30363d] rounded bg-[#0d1117] p-2 overflow-auto">
                                            <div className="text-[#8b949e] mb-2 uppercase text-[10px]">C# Source</div>
                                            <div className="text-red-300">public class UserController : Controller {'{'}</div>
                                            <div className="text-[#c9d1d9] pl-4">private UserContext db = new UserContext();</div>
                                            <div className="text-[#8b949e] pl-4 italic">// ISSUE: Direct DB Access</div>
                                            <div className="text-[#c9d1d9] pl-4">return View(db.Users.ToList());</div>
                                            <div className="text-red-300">{'}'}</div>
                                        </div>
                                        <div className="w-1/2 border border-[#30363d] rounded bg-[#0d1117] p-2 overflow-auto">
                                            <div className="text-[#238636] mb-2 uppercase text-[10px]">Python Target</div>
                                            <div className="text-green-300">@router.get("/users")</div>
                                            <div className="text-[#c9d1d9]">async def read_users(db: Session = Depends(get_db)):</div>
                                            <div className="text-[#8b949e] pl-4 italic"># FIXED: Async & DI</div>
                                            <div className="text-[#c9d1d9] pl-4">return service.get_all_users(db)</div>
                                        </div>
                                    </div>
                                )}

                                {activeFile === 'report' && (
                                    <div className="flex flex-col items-center justify-center h-full">
                                        <div className="bg-[#161b22] p-6 rounded-lg border border-[#30363d] max-w-md w-full">
                                            <h3 className="text-white font-bold mb-4 flex items-center gap-2"><Icon name="Server" className="text-blue-400"/> New Architecture</h3>
                                            <div className="space-y-2 text-xs">
                                                <div className="flex justify-between"><span className="text-[#8b949e]">Service:</span> <span className="text-[#c9d1d9]">AWS ECS Fargate</span></div>
                                                <div className="flex justify-between"><span className="text-[#8b949e]">Language:</span> <span className="text-[#c9d1d9]">Python 3.11</span></div>
                                                <div className="flex justify-between"><span className="text-[#8b949e]">Database:</span> <span className="text-[#c9d1d9]">PostgreSQL (RDS)</span></div>
                                                <div className="flex justify-between"><span className="text-[#8b949e]">Pipeline:</span> <span className="text-green-400">Bitbucket Pipelines</span></div>
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>

                            {/* Bottom Panel */}
                            <div className="h-40 border-t border-[#30363d] bg-[#010409] flex flex-col">
                                <div className="flex border-b border-[#30363d]">
                                    <button onClick={() => setActiveTab('terminal')} className={`px-4 py-1 text-xs ${activeTab === 'terminal' ? 'text-white border-b border-[#f78166]' : 'text-[#8b949e]'}`}>Terminal</button>
                                    <button onClick={() => setActiveTab('mcp')} className={`px-4 py-1 text-xs ${activeTab === 'mcp' ? 'text-white border-b border-[#f78166]' : 'text-[#8b949e]'}`}>MCP Tools</button>
                                </div>
                                <div className="flex-1 overflow-auto p-2 font-mono text-xs">
                                    {activeTab === 'terminal' && (
                                        <div>
                                            {terminalLogs.map((l, i) => <div key={i} className="text-[#8b949e]">{l}</div>)}
                                            <div ref={terminalEndRef}/>
                                        </div>
                                    )}
                                    {activeTab === 'mcp' && (
                                        <div className="grid grid-cols-2 gap-2">
                                            {MCP_TOOLS.map(t => (
                                                <div key={t.name} className="flex items-center justify-between p-2 border border-[#30363d] rounded bg-[#0d1117]">
                                                    <div className="flex items-center gap-2 text-[#c9d1d9]">
                                                        <Icon name="Activity" size={12} className={t.status === 'Active' ? 'text-green-400' : 'text-[#8b949e]'}/>
                                                        {t.name}
                                                    </div>
                                                </div>
                                            ))}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>

                        {/* Right Chat */}
                        <div className="w-72 bg-[#0d1117] flex flex-col border-l border-[#30363d] shrink-0">
                            <div className="p-2 text-xs font-bold text-[#8b949e] uppercase tracking-wider border-b border-[#30363d]">Agent Chat</div>
                            <div className="flex-1 overflow-y-auto p-3 space-y-3">
                                {agentChat.map((c, i) => (
                                    <div key={i} className={`flex ${c.role === 'user' ? 'justify-end' : 'justify-start'}`}>
                                        <div className={`max-w-[90%] p-2 rounded text-xs border ${c.role === 'user' ? 'bg-[#1f6feb]/20 border-[#1f6feb]/50 text-white' : 'bg-[#161b22] border-[#30363d] text-[#c9d1d9]'}`}>
                                            <div className="font-bold opacity-50 mb-0.5 uppercase text-[8px]">{c.role}</div>
                                            {c.text}
                                        </div>
                                    </div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(
            <ErrorBoundary>
                <App />
            </ErrorBoundary>
        );
    </script>
</body>
</html>

